<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Voice Call (WebRTC + Firebase)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        button {
            background: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:disabled {
            background: #cccccc;
        }
        #callId {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }
        #status {
            font-weight: bold;
            margin: 20px 0;
            min-height: 24px;
        }
        #audioContainer {
            margin-top: 20px;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>P2P Voice Call</h1>
    <p>Share the Call ID with the other device!</p>

    <div>
        <input type="text" id="callId" placeholder="Enter Call ID">
        <button id="startCall">Start Call</button>
        <button id="endCall" disabled>End Call</button>
    </div>

    <div id="status">Status: Ready</div>
    <div id="audioContainer"></div>

    <script>
        // Firebase Config (Replace with yours!)
        const firebaseConfig = {
              apiKey: "AIzaSyAyeNF9eqEc2lpohD54NFLbjkdn0L5cPIs",
  authDomain: "webrtc-d0c3e.firebaseapp.com",
  databaseURL: "https://webrtc-d0c3e-default-rtdb.firebaseio.com",
  projectId: "webrtc-d0c3e",
  storageBucket: "webrtc-d0c3e.firebasestorage.app",
  messagingSenderId: "347788572119",
  appId: "1:347788572119:web:7534af31dd6ebe64430792",
  
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // WebRTC Variables
        let peerConnection;
        let localStream;
        let callDoc;
        let offerCandidates;
        let answerCandidates;

        // DOM Elements
        const callIdInput = document.getElementById('callId');
        const startCallBtn = document.getElementById('startCall');
        const endCallBtn = document.getElementById('endCall');
        const statusDiv = document.getElementById('status');
        const audioContainer = document.getElementById('audioContainer');

        // Start Call
        startCallBtn.addEventListener('click', async () => {
            const callId = callIdInput.value.trim();
            if (!callId) {
                statusDiv.textContent = "Status: Enter a Call ID!";
                return;
            }

            statusDiv.textContent = "Status: Starting call...";
            startCallBtn.disabled = true;
            endCallBtn.disabled = false;

            try {
                // Get microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Create PeerConnection
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }] // Free STUN server
                });

                // Add local stream to connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Listen for remote stream
                peerConnection.ontrack = (event) => {
                    const remoteAudio = document.createElement('audio');
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.autoplay = true;
                    audioContainer.innerHTML = '';
                    audioContainer.appendChild(remoteAudio);
                    statusDiv.textContent = "Status: Call Connected!";
                };

                // Firebase signaling
                callDoc = db.collection('calls').doc(callId);
                offerCandidates = callDoc.collection('offerCandidates');
                answerCandidates = callDoc.collection('answerCandidates');

                // ICE Candidate Handling
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        offerCandidates.add(event.candidate.toJSON());
                    }
                };

                // Create Offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Save Offer to Firebase
                await callDoc.set({
                    offer: {
                        type: offer.type,
                        sdp: offer.sdp
                    }
                });

                // Listen for Answer
                callDoc.onSnapshot((snapshot) => {
                    const data = snapshot.data();
                    if (!peerConnection.currentRemoteDescription && data?.answer) {
                        const answer = new RTCSessionDescription(data.answer);
                        peerConnection.setRemoteDescription(answer);
                    }
                });

                // Listen for Remote ICE Candidates
                answerCandidates.onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            peerConnection.addIceCandidate(candidate);
                        }
                    });
                });

            } catch (error) {
                console.error("Call failed:", error);
                statusDiv.textContent = `Status: Error - ${error.message}`;
                startCallBtn.disabled = false;
                endCallBtn.disabled = true;
            }
        });

        // End Call
        endCallBtn.addEventListener('click', () => {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (callDoc) callDoc.delete(); // Cleanup Firebase
            audioContainer.innerHTML = '';
            statusDiv.textContent = "Status: Call Ended";
            startCallBtn.disabled = false;
            endCallBtn.disabled = true;
        });
    </script>
</body>
</html>
